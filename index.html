<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estoque</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="assets/css/base.css">
</head>
<body>
    <!-- Sidebar -->
    <nav id="sidebar">
        <div class="p-3">
            <h4 class="text-white">Menu</h4>
            <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('stock')">Estoque</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('entry')">Entrada</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('exit')">Saída</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('suppliers')">Fornecedores</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('orders')">Pedidos</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('charts')">Gráficos</a></li>
            </ul>
        </div>
    </nav>

    <!-- Content -->
    <div id="content">
        <button class="btn btn-dark mb-3" onclick="toggleSidebar()" id="toogleSIdeBar">
            <i class="bi bi-list"></i> Menu
        </button>

        <!-- Stock Section -->
        <div id="stockSection" class="section active">
            <h2>Estoque</h2>
            <div class="d-flex justify-content-between mb-3">
                <input type="text" id="searchInput" class="form-control w-50" placeholder="Pesquisar...">
                <button class="btn-custom" data-bs-toggle="modal" data-bs-target="#addProductModal" onclick="prepareAddProduct()">
                    <i class="bi bi-plus-circle"></i> Adicionar Produto
                </button>
            </div>

            <!-- Tabs -->
            <ul class="nav nav-tabs" id="stockTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="tinta-tab" data-bs-toggle="tab" data-bs-target="#tinta" type="button" role="tab" aria-controls="tinta" aria-selected="true">Tintas</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="papel-tab" data-bs-toggle="tab" data-bs-target="#papel" type="button" role="tab" aria-controls="papel" aria-selected="false">Papéis</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tecido-tab" data-bs-toggle="tab" data-bs-target="#tecido" type="button" role="tab" aria-controls="tecido" aria-selected="false">Tecidos</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tecido-cortado-tab" data-bs-toggle="tab" data-bs-target="#tecido-cortado" type="button" role="tab" aria-controls="tecido-cortado" aria-selected="false">Tecidos Cortados</button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="stockTabContent">
                <!-- Tinta Table -->
                <div class="tab-pane fade show active" id="tinta" role="tabpanel" aria-labelledby="tinta-tab">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-bordered">
                            <thead class="table-dark">
                                <tr>
                                    <th>Cor</th>
                                    <th>Tipo</th>
                                    <th>Quantidade (Frascos)</th>
                                    <th>Litros por Frasco</th>
                                    <th>Total Litros</th>
                                    <th>Quantidade Mínima</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tintaTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Papel Table -->
                <div class="tab-pane fade" id="papel" role="tabpanel" aria-labelledby="papel-tab">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-bordered">
                            <thead class="table-dark">
                                <tr>
                                    <th>Tipo</th>
                                    <th>Quantidade (Rolos)</th>
                                    <th>Metros por Rolo</th>
                                    <th>Total Metros</th>
                                    <th>Quantidade Mínima</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="papelTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tecido Table -->
                <div class="tab-pane fade" id="tecido" role="tabpanel" aria-labelledby="tecido-tab">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-bordered">
                            <thead class="table-dark">
                                <tr>
                                    <th>Tipo</th>
                                    <th>Quantidade (Metros)</th>
                                    <th>Largura (cm)</th>
                                    <th>Quantidade Mínima</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tecidoTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tecido Cortado Table -->
                <div class="tab-pane fade" id="tecido-cortado" role="tabpanel" aria-labelledby="tecido-cortado-tab">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-bordered">
                            <thead class="table-dark">
                                <tr>
                                    <th>Tipo</th>
                                    <th>Quantidade</th>
                                    <th>Medida (LxA)</th>
                                    <th>Quantidade Mínima</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tecidoCortadoTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Entry Section -->
        <div id="entrySection" class="section">
            <h2>Entrada de Estoque</h2>
            <form id="entryForm">
                <div class="mb-3">
                    <label for="entryProduct" class="form-label">Produto</label>
                    <select class="form-select" id="entryProduct" required>
                        <option value="" disabled selected>Selecione um produto</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="entryQuantity" class="form-label">Quantidade</label>
                    <input type="number" step="any" class="form-control" id="entryQuantity" min="0.01" required>
                </div>
                <div class="mb-3">
                    <label for="entrySupplier" class="form-label">Fornecedor</label>
                    <select class="form-select" id="entrySupplier" required>
                        <option value="" disabled selected>Selecione um fornecedor</option>
                    </select>
                </div>
                <button type="submit" class="btn-custom">Registrar Entrada</button>
            </form>
        </div>

        <!-- Exit Section -->
        <div id="exitSection" class="section">
            <h2>Saída de Estoque</h2>
            <form id="exitForm">
                <div class="mb-3">
                    <label for="exitProduct" class="form-label">Produto</label>
                    <select class="form-select" id="exitProduct" required>
                        <option value="" disabled selected>Selecione um produto</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="exitQuantity" class="form-label">Quantidade</label>
                    <input type="number" step="any" class="form-control" id="exitQuantity" min="0.01" required>
                </div>
                <button type="submit" class="btn-custom">Registrar Saída</button>
            </form>
        </div>

        <!-- Suppliers Section -->
        <div id="suppliersSection" class="section">
            <h2>Fornecedores</h2>
            <button class="btn-custom mb-3" data-bs-toggle="modal" data-bs-target="#addSupplierModal">
                <i class="bi bi-plus-circle"></i> Adicionar Fornecedor
            </button>
            <div class="table-responsive">
                <table class="table table-striped table-hover table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>Nome</th>
                            <th>Telefone</th>
                            <th>Email</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="suppliersTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Orders Section -->
        <div id="ordersSection" class="section">
            <h2>Pedidos</h2>
            <form id="orderForm">
                <div class="mb-3">
                    <label for="orderProduct" class="form-label">Produto</label>
                    <select class="form-select" id="orderProduct" required>
                        <option value="" disabled selected>Selecione um produto</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="orderQuantity" class="form-label">Quantidade</label>
                    <input type="number" step="any" class="form-control" id="orderQuantity" min="0.01" required>
                </div>
                <div class="mb-3">
                    <label for="orderSupplier" class="form-label">Fornecedor</label>
                    <select class="form-select" id="orderSupplier" required>
                        <option value="" disabled selected>Selecione um fornecedor</option>
                    </select>
                </div>
                <button type="submit" class="btn-custom">Gerar Pedido</button>
            </form>
        </div>

        <!-- Charts Section -->
        <div id="chartsSection" class="section">
            <h2>Gráficos</h2>
            <canvas id="stockChart" width="400" height="200"></canvas>
        </div>

        <!-- Add/Edit Product Modal -->
        <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addProductModalLabel">Adicionar Produto</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addProductForm">
                            <input type="hidden" id="editProductId">
                            <input type="hidden" id="editProductCategory">
                            <div class="mb-3">
                                <label for="productCategory" class="form-label">Categoria</label>
                                <select class="form-select" id="productCategory" required>
                                    <option value="" disabled selected>Selecione uma categoria</option>
                                    <option value="tinta">Tinta</option>
                                    <option value="papel">Papel</option>
                                    <option value="tecido">Tecido</option>
                                    <option value="tecido-cortado">Tecido Cortado</option>
                                </select>
                            </div>

                            <!-- Tinta Form -->
                            <div id="form-tinta" class="hidden-form">
                                <div class="mb-3">
                                    <label for="typeColor" class="form-label">Cor</label>
                                    <select class="form-select" id="typeColor">
                                        <option value="" disabled selected>Selecione a Cor</option>
                                        <option value="cyan">Cyan</option>
                                        <option value="magenta">Magenta</option>
                                        <option value="amarelo">Amarelo</option>
                                        <option value="preto">Preto</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="typeTinta" class="form-label">Tipo</label>
                                    <select class="form-select" id="typeTinta">
                                        <option value="" disabled selected>Selecione o Tipo</option>
                                        <option value="sublimacao">Sublimação</option>
                                        <option value="pigmentada">Pigmentada</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="productQty" class="form-label">Quantidade (Frascos)</label>
                                    <input type="number" class="form-control" id="productQty" min="1" required>
                                </div>
                                <div class="mb-3">
                                    <label for="productQtyLitros" class="form-label">Litros por Frasco</label>
                                    <input type="number" step="0.01" class="form-control" id="productQtyLitros" min="0.01" required>
                                </div>
                                <div class="mb-3">
                                    <label for="productQtyMin" class="form-label">Quantidade Mínima</label>
                                    <input type="number" step="0.01" class="form-control" id="productQtyMin" min="0">
                                </div>
                            </div>

                            <!-- Papel Form -->
                            <div id="form-papel" class="hidden-form">
                                <div class="mb-3">
                                    <label for="typePapel" class="form-label">Tipo</label>
                                    <select class="form-select" id="typePapel" required>
                                        <option value="" disabled selected>Selecione o Tipo</option>
                                        <option value="papel1">Art 45gr 160x250</option>
                                        <option value="papel2">Art 45gr 180x400</option>
                                        <option value="papel3">Art 45gr 160x1000</option>
                                        <option value="papel4">Coldenhove 40gr 162x400</option>
                                        <option value="papel5">Seda 20gr 160x1000</option>
                                        <option value="papel6">Kraft 35gr 160x500</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="productQtyUnit" class="form-label">Quantidade (Rolos)</label>
                                    <input type="number" class="form-control" id="productQtyUnit" min="1" required>
                                </div>
                                <div class="mb-3">
                                    <label for="productQtyMetros" class="form-label">Metros por Rolo</label>
                                    <input type="number" class="form-control" id="productQtyMetros" min="1" required>
                                </div>
                                <div class="mb-3">
                                    <label for="productQtyMin" class="form-label">Quantidade Mínima</label>
                                    <input type="number" step="0.01" class="form-control" id="productQtyMin" min="0">
                                </div>
                            </div>

                            <!-- Tecido Form -->
                            <div id="form-tecido" class="hidden-form">
                                <div class="mb-3">
                                    <label for="typeTecido" class="form-label">Tipo</label>
                                    <input type="text" class="form-control" id="typeTecido" required>
                                </div>
                                <div class="mb-3">
                                    <label for="productQtyMetrosTecido" class="form-label">Quantidade (Metros)</label>
                                    <input type="number" step="0.01" class="form-control" id="productQtyMetrosTecido" min="0.01" required>
                                </div>
                                <div class="mb-3">
                                    <label for="productWidth" class="form-label">Largura (cm)</label>
                                    <input type="number" step="0.01" class="form-control" id="productWidth" min="0.01" required>
                                </div>
                                <div class="mb-3">
                                    <label for="productQtyMin" class="form-label">Quantidade Mínima</label>
                                    <input type="number" step="0.01" class="form-control" id="productQtyMin" min="0">
                                </div>
                            </div>

                            <!-- Tecido Cortado Form -->
                            <div id="form-tecido-cortado" class="hidden-form">
                                <div class="mb-3">
                                    <label for="typeTecidoCortado" class="form-label">Tipo</label>
                                    <select class="form-select" id="typeTecidoCortado" required>
                                        <option value="" disabled selected>Selecione o Tipo</option>
                                        <option value="malha">Malha</option>
                                        <option value="tactel">Tactel</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="productQtyTecidoCortado" class="form-label">Quantidade</label>
                                    <input type="number" class="form-control" id="productQtyTecidoCortado" min="1" required>
                                </div>
                                <div class="mb-3">
                                    <label for="productMedida" class="form-label">Medida (Largura x Altura, cm)</label>
                                    <div class="row">
                                        <div class="col">
                                            <input type="number" step="0.01" class="form-control" id="productMedidaLargura" placeholder="Largura" min="0.01" required>
                                        </div>
                                        <div class="col-auto">x</div>
                                        <div class="col">
                                            <input type="number" step="0.01" class="form-control" id="productMedidaAltura" placeholder="Altura" min="0.01" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="productQtyMin" class="form-label">Quantidade Mínima</label>
                                    <input type="number" step="0.01" class="form-control" id="productQtyMin" min="0">
                                </div>
                            </div>

                            <button type="button" class="btn-custom" id="saveProductButton" onclick="saveProduct()">Salvar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Supplier Modal -->
        <div class="modal fade" id="addSupplierModal" tabindex="-1" aria-labelledby="addSupplierModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addSupplierModalLabel">Adicionar Fornecedor</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addSupplierForm">
                            <div class="mb-3">
                                <label for="supplierName" class="form-label">Nome</label>
                                <input type="text" class="form-control" id="supplierName" required>
                            </div>
                            <div class="mb-3">
                                <label for="supplierPhone" class="form-label">Telefone</label>
                                <input type="tel" class="form-control" id="supplierPhone" required>
                            </div>
                            <div class="mb-3">
                                <label for="supplierEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="supplierEmail" required>
                            </div>
                            <button type="submit" class="btn-custom">Salvar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = "https://estoque-v4.onrender.com";
        const category = document.getElementById("productCategory");
        const formTinta = document.getElementById("form-tinta");
        const formPapel = document.getElementById("form-papel");
        const formTecido = document.getElementById("form-tecido");
        const formTecidoCortado = document.getElementById("form-tecido-cortado");

        // Paper type mapping
        const paperTypeMap = {
            papel1: "Art 45gr 160x250",
            papel2: "Art 45gr 180x400",
            papel3: "Art 45gr 160x1000",
            papel4: "Coldenhove 40gr 162x400",
            papel5: "Seda 20gr 160x1000",
            papel6: "Kraft 35gr 160x500"
        };

        // Show alert
        function showAlert(message, type = 'success') {
            const alertContainer = document.createElement('div');
            alertContainer.className = `alert alert-${type} alert-dismissible fade show`;
            alertContainer.role = 'alert';
            alertContainer.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.body.appendChild(alertContainer);
            setTimeout(() => alertContainer.remove(), 5000);
        }

        // Fetch data
        async function fetchTinta() {
            try {
                const response = await fetch(`${API_URL}/products-tinta`);
                if (!response.ok) throw new Error("Failed to fetch tintas");
                return await response.json();
            } catch (error) {
                console.error(error);
                return [];
            }
        }

        async function fetchPapel() {
            try {
                const response = await fetch(`${API_URL}/products-papel`);
                if (!response.ok) throw new Error("Failed to fetch papéis");
                return await response.json();
            } catch (error) {
                console.error(error);
                return [];
            }
        }

        async function fetchTecido() {
            try {
                const response = await fetch(`${API_URL}/products-tecido`);
                if (!response.ok) throw new Error("Failed to fetch tecidos");
                return await response.json();
            } catch (error) {
                console.error(error);
                return [];
            }
        }

        async function fetchTecidoCortado() {
            try {
                const response = await fetch(`${API_URL}/products-tecido-cortado`);
                const data = await response.json();
                console.log("Resposta da API para tecidos cortados:", data);
                if (!response.ok) throw new Error("Failed to fetch tecidos cortados");
                return data;
            } catch (error) {
                console.error("Erro ao buscar tecidos cortados:", error);
                return [];
            }
        }

        async function fetchSuppliers() {
            try {
                const response = await fetch(`${API_URL}/suppliers`);
                if (!response.ok) throw new Error("Failed to fetch suppliers");
                return await response.json();
            } catch (error) {
                console.error(error);
                return [];
            }
        }

        async function fetchProduct(category, id) {
            try {
                const response = await fetch(`${API_URL}/products-${category}/${id}`);
                if (!response.ok) throw new Error(`Failed to fetch ${category} ${id}`);
                return await response.json();
            } catch (error) {
                console.error(error);
                return null;
            }
        }

        // Render tables
        async function renderTintaTable() {
            const tintas = await fetchTinta();
            const tableBody = document.getElementById("tintaTableBody");
            tableBody.innerHTML = "";
            tintas.forEach(tinta => {
                const totalLitros = (tinta.productQty * tinta.productQtyLitros).toFixed(2);
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${tinta.color || '-'}</td>
                    <td>${tinta.type || '-'}</td>
                    <td>${tinta.productQty || 0}</td>
                    <td>${tinta.productQtyLitros || 0}</td>
                    <td>${totalLitros}</td>
                    <td>${tinta.qtyMin || 0}</td>
                    <td>
                        <button class="btn btn-primary btn-sm me-1" onclick="editProduct('tinta', ${tinta.id})">
                            <i class="bi bi-pencil"></i> Editar
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="removeProduct('tinta', ${tinta.id})">
                            <i class="bi bi-trash"></i> Remover
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function renderPapelTable() {
            const papeis = await fetchPapel();
            const tableBody = document.getElementById("papelTableBody");
            tableBody.innerHTML = "";
            papeis.forEach(papel => {
                const displayName = paperTypeMap[papel.type] || papel.type;
                const totalMetros = papel.qtyUnit * papel.qtyMetros;
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${displayName || '-'}</td>
                    <td>${papel.qtyUnit || 0}</td>
                    <td>${papel.qtyMetros || 0}</td>
                    <td>${totalMetros || 0}</td>
                    <td>${papel.qtyMin || 0}</td>
                    <td>
                        <button class="btn btn-primary btn-sm me-1" onclick="editProduct('papel', ${papel.id})">
                            <i class="bi bi-pencil"></i> Editar
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="removeProduct('papel', ${papel.id})">
                            <i class="bi bi-trash"></i> Remover
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function renderTecidoTable() {
            const tecidos = await fetchTecido();
            const tableBody = document.getElementById("tecidoTableBody");
            tableBody.innerHTML = "";
            tecidos.forEach(tecido => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${tecido.type || '-'}</td>
                    <td>${tecido.qtyMetros || 0}</td>
                    <td>${tecido.width || 0}</td>
                    <td>${tecido.qtyMin || 0}</td>
                    <td>
                        <button class="btn btn-primary btn-sm me-1" onclick="editProduct('tecido', ${tecido.id})">
                            <i class="bi bi-pencil"></i> Editar
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="removeProduct('tecido', ${tecido.id})">
                            <i class="bi bi-trash"></i> Remover
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function renderTecidoCortadoTable() {
            const tecidosCortados = await fetchTecidoCortado();
            console.log("Dados para renderizar tecidos cortados:", tecidosCortados);
            const tableBody = document.getElementById("tecidoCortadoTableBody");
            tableBody.innerHTML = "";
            if (!tecidosCortados || tecidosCortados.length === 0) {
                const row = document.createElement("tr");
                row.innerHTML = `<td colspan="5">Nenhum tecido cortado encontrado</td>`;
                tableBody.appendChild(row);
                return;
            }
            tecidosCortados.forEach(tecido => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${tecido.type || '-'}</td>
                    <td>${tecido.quantity || 0}</td>
                    <td>${tecido.measurement || '-'}</td>
                    <td>${tecido.qtyMin || 0}</td>
                    <td>
                        <button class="btn btn-primary btn-sm me-1" onclick="editProduct('tecido-cortado', ${tecido.id || 0})">
                            <i class="bi bi-pencil"></i> Editar
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="removeProduct('tecido-cortado', ${tecido.id || 0})">
                            <i class="bi bi-trash"></i> Remover
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function renderSuppliers() {
            const suppliers = await fetchSuppliers();
            const tableBody = document.getElementById("suppliersTableBody");
            tableBody.innerHTML = "";
            suppliers.forEach(supplier => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${supplier.name || '-'}</td>
                    <td>${supplier.phone || '-'}</td>
                    <td>${supplier.email || '-'}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="removeSupplier(${supplier.id || 0})">
                            <i class="bi bi-trash"></i> Remover
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Edit product
        async function editProduct(category, id) {
            const product = await fetchProduct(category, id);
            if (!product) {
                showAlert(`Erro ao carregar ${category} para edição`, 'danger');
                return;
            }

            document.getElementById("addProductModalLabel").textContent = `Editar ${category.charAt(0).toUpperCase() + category.slice(1)}`;
            document.getElementById("editProductId").value = id;
            document.getElementById("editProductCategory").value = category;
            document.getElementById("productCategory").value = category;
            document.getElementById("productCategory").dispatchEvent(new Event('change'));

            if (category === "tinta") {
                document.getElementById("typeColor").value = product.color || '';
                document.getElementById("typeTinta").value = product.type || '';
                document.getElementById("productQty").value = product.productQty || '';
                document.getElementById("productQtyLitros").value = product.productQtyLitros || '';
                document.getElementById("productQtyMin").value = product.qtyMin || '';
            } else if (category === "papel") {
                document.getElementById("typePapel").value = product.type || '';
                document.getElementById("productQtyUnit").value = product.qtyUnit || '';
                document.getElementById("productQtyMetros").value = product.qtyMetros || '';
                document.getElementById("productQtyMin").value = product.qtyMin || '';
            } else if (category === "tecido") {
                document.getElementById("typeTecido").value = product.type || '';
                document.getElementById("productQtyMetrosTecido").value = product.qtyMetros || '';
                document.getElementById("productWidth").value = product.width || '';
                document.getElementById("productQtyMin").value = product.qtyMin || '';
            } else if (category === "tecido-cortado") {
                document.getElementById("typeTecidoCortado").value = product.type || '';
                document.getElementById("productQtyTecidoCortado").value = product.quantity || '';
                if (product.measurement && product.measurement.includes('x')) {
                    const [width, height] = product.measurement.split('x').map(parseFloat);
                    document.getElementById("productMedidaLargura").value = width || '';
                    document.getElementById("productMedidaAltura").value = height || '';
                } else {
                    document.getElementById("productMedidaLargura").value = '';
                    document.getElementById("productMedidaAltura").value = '';
                }
                document.getElementById("productQtyMin").value = product.qtyMin || '';
            }

            const modal = new bootstrap.Modal(document.getElementById("addProductModal"));
            modal.show();
        }

        // Save product (handles both add and edit)
        async function saveProduct() {
            const editId = document.getElementById("editProductId").value;
            const category = editId ? document.getElementById("editProductCategory").value : document.getElementById("productCategory").value;

            try {
                let product, endpoint, categoryName, method;
                if (category === "tinta") {
                    const color = document.getElementById("typeColor").value;
                    const type = document.getElementById("typeTinta").value;
                    const productQty = parseInt(document.getElementById("productQty").value);
                    const productQtyLitros = parseFloat(document.getElementById("productQtyLitros").value);
                    const qtyMin = parseFloat(document.getElementById("productQtyMin").value) || 0;

                    if (!color || !type) throw new Error("Cor e tipo de tinta são obrigatórios");
                    if (isNaN(productQty) || productQty <= 0) throw new Error("Quantidade deve ser um número positivo");
                    if (isNaN(productQtyLitros) || productQtyLitros <= 0) throw new Error("Litros por frasco deve ser um número positivo");
                    if (qtyMin < 0) throw new Error("Quantidade mínima não pode ser negativa");

                    product = { color, type, productQty, productQtyLitros, qtyMin };
                    endpoint = editId ? `${API_URL}/products-tinta/${editId}` : `${API_URL}/products-tinta`;
                    categoryName = "tinta";
                } else if (category === "papel") {
                    const type = document.getElementById("typePapel").value;
                    const qtyUnit = parseInt(document.getElementById("productQtyUnit").value);
                    const qtyMetros = parseInt(document.getElementById("productQtyMetros").value);
                    const qtyMin = parseFloat(document.getElementById("productQtyMin").value) || 0;

                    if (!type) throw new Error("Tipo de papel é obrigatório");
                    if (isNaN(qtyUnit) || qtyUnit <= 0) throw new Error("Quantidade de rolos deve ser um número positivo");
                    if (isNaN(qtyMetros) || qtyMetros <= 0) throw new Error("Metros por rolo deve ser um número positivo");
                    if (qtyMin < 0) throw new Error("Quantidade mínima não pode ser negativa");

                    product = { type, qtyUnit, qtyMetros, qtyMin };
                    endpoint = editId ? `${API_URL}/products-papel/${editId}` : `${API_URL}/products-papel`;
                    categoryName = "papel";
                } else if (category === "tecido") {
                    const type = document.getElementById("typeTecido").value;
                    const qtyMetros = parseFloat(document.getElementById("productQtyMetrosTecido").value);
                    const width = parseFloat(document.getElementById("productWidth").value);
                    const qtyMin = parseFloat(document.getElementById("productQtyMin").value) || 0;

                    if (!type) throw new Error("Tipo de tecido é obrigatório");
                    if (isNaN(qtyMetros) || qtyMetros <= 0) throw new Error("Quantidade de metros deve ser um número positivo");
                    if (isNaN(width) || width <= 0) throw new Error("Largura deve ser um número positivo");
                    if (qtyMin < 0) throw new Error("Quantidade mínima não pode ser negativa");

                    product = { type, qtyMetros, width, qtyMin };
                    endpoint = editId ? `${API_URL}/products-tecido/${editId}` : `${API_URL}/products-tecido`;
                    categoryName = "tecido";
                } else if (category === "tecido-cortado") {
                    const type = document.getElementById("typeTecidoCortado").value;
                    const quantity = parseInt(document.getElementById("productQtyTecidoCortado").value);
                    const medidaLargura = parseFloat(document.getElementById("productMedidaLargura").value);
                    const medidaAltura = parseFloat(document.getElementById("productMedidaAltura").value);
                    const qtyMin = parseFloat(document.getElementById("productQtyMin").value) || 0;

                    if (!type) throw new Error("Tipo de tecido cortado é obrigatório");
                    if (isNaN(quantity) || quantity <= 0) throw new Error("Quantidade deve ser um número positivo");
                    if (isNaN(medidaLargura) || medidaLargura <= 0) throw new Error("Largura deve ser um número positivo");
                    if (isNaN(medidaAltura) || medidaAltura <= 0) throw new Error("Altura deve ser um número positivo");
                    if (qtyMin < 0) throw new Error("Quantidade mínima não pode ser negativa");

                    const measurement = `${medidaLargura}x${medidaAltura}`;
                    product = { type, quantity, measurement, qtyMin };
                    endpoint = editId ? `${API_URL}/products-tecido-cortado/${editId}` : `${API_URL}/products-tecido-cortado`;
                    categoryName = "tecido-cortado";
                } else {
                    throw new Error("Categoria inválida selecionada");
                }

                method = editId ? "PUT" : "POST";
                const response = await fetch(endpoint, {
                    method,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(product)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `Failed to ${editId ? 'edit' : 'add'} ${categoryName}`);
                }

                document.getElementById("addProductForm").reset();
                document.getElementById("editProductId").value = "";
                document.getElementById("editProductCategory").value = "";
                const modal = bootstrap.Modal.getInstance(document.getElementById("addProductModal"));
                modal.hide();

                if (categoryName === "tinta") await renderTintaTable();
                else if (categoryName === "papel") await renderPapelTable();
                else if (categoryName === "tecido") await renderTecidoTable();
                else if (categoryName === "tecido-cortado") await renderTecidoCortadoTable();

                await updateProductSelects();
                showAlert(`${categoryName.charAt(0).toUpperCase() + categoryName.slice(1)} ${editId ? 'editado' : 'adicionado'} com sucesso!`);

            } catch (error) {
                console.error(error);
                showAlert(`Erro: ${error.message}`, 'danger');
            }
        }

        // Remove product
        async function removeProduct(category, id) {
            if (confirm(`Tem certeza que deseja remover este ${category}?`)) {
                try {
                    const endpoint = `${API_URL}/products-${category}/${id}`;
                    const response = await fetch(endpoint, { method: "DELETE" });
                    if (!response.ok) throw new Error(`Failed to delete ${category}`);
                    if (category === "tinta") await renderTintaTable();
                    else if (category === "papel") await renderPapelTable();
                    else if (category === "tecido") await renderTecidoTable();
                    else if (category === "tecido-cortado") await renderTecidoCortadoTable();
                    await updateProductSelects();
                    showAlert(`${category.charAt(0).toUpperCase() + category.slice(1)} removido com sucesso!`);
                } catch (error) {
                    console.error(error);
                    showAlert(`Erro ao remover ${category}: ${error.message}`, 'danger');
                }
            }
        }

        // Handle stock entry
        async function handleStockEntry(event) {
            event.preventDefault();
            try {
                const productSelect = document.getElementById("entryProduct").value;
                const quantity = parseFloat(document.getElementById("entryQuantity").value);
                const supplierId = document.getElementById("entrySupplier").value;

                if (!productSelect) throw new Error("Selecione um produto");
                if (isNaN(quantity) || quantity <= 0) throw new Error("Quantidade deve ser um número positivo");
                if (!supplierId) throw new Error("Selecione um fornecedor");

                const [category, productId] = productSelect.split('_');
                const entry = {
                    category,
                    product_id: parseInt(productId),
                    quantity,
                    supplier_id: parseInt(supplierId)
                };

                const response = await fetch(`${API_URL}/entries`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(entry)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || "Failed to register entry");
                }

                document.getElementById("entryForm").reset();
                if (category === "tinta") await renderTintaTable();
                else if (category === "papel") await renderPapelTable();
                else if (category === "tecido") await renderTecidoTable();
                else if (category === "tecido-cortado") await renderTecidoCortadoTable();
                showAlert("Entrada registrada com sucesso!");
            } catch (error) {
                console.error(error);
                showAlert(`Erro ao registrar entrada: ${error.message}`, 'danger');
            }
        }

        // Handle stock exit
        async function handleStockExit(event) {
            event.preventDefault();
            try {
                const productSelect = document.getElementById("exitProduct").value;
                const quantity = parseFloat(document.getElementById("exitQuantity").value);

                if (!productSelect) throw new Error("Selecione um produto");
                if (isNaN(quantity) || quantity <= 0) throw new Error("Quantidade deve ser um número positivo");

                const [category, productId] = productSelect.split('_');
                const exit = {
                    category,
                    product_id: parseInt(productId),
                    quantity
                };

                const response = await fetch(`${API_URL}/exits`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(exit)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || "Failed to register exit");
                }

                document.getElementById("exitForm").reset();
                if (category === "tinta") await renderTintaTable();
                else if (category === "papel") await renderPapelTable();
                else if (category === "tecido") await renderTecidoTable();
                else if (category === "tecido-cortado") await renderTecidoCortadoTable();
                showAlert("Saída registrada com sucesso!");
            } catch (error) {
                console.error(error);
                showAlert(`Erro ao registrar saída: ${error.message}`, 'danger');
            }
        }

        // Search functionality
        document.getElementById("searchInput").addEventListener("input", async function () {
            const query = this.value.toLowerCase();
            const activeTab = document.querySelector("#stockTabs .nav-link.active").id;
            if (activeTab === "tinta-tab") {
                const tintas = await fetchTinta();
                const filtered = tintas.filter(tinta => 
                    (tinta.color || '').toLowerCase().includes(query) || 
                    (tinta.type || '').toLowerCase().includes(query)
                );
                const tableBody = document.getElementById("tintaTableBody");
                tableBody.innerHTML = "";
                filtered.forEach(tinta => {
                    const totalLitros = (tinta.productQty * tinta.productQtyLitros).toFixed(2);
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${tinta.color || '-'}</td>
                        <td>${tinta.type || '-'}</td>
                        <td>${tinta.productQty || 0}</td>
                        <td>${tinta.productQtyLitros || 0}</td>
                        <td>${totalLitros}</td>
                        <td>${tinta.qtyMin || 0}</td>
                        <td>
                            <button class="btn btn-primary btn-sm me-1" onclick="editProduct('tinta', ${tinta.id || 0})">
                                <i class="bi bi-pencil"></i> Editar
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="removeProduct('tinta', ${tinta.id || 0})">
                                <i class="bi bi-trash"></i> Remover
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } else if (activeTab === "papel-tab") {
                const papeis = await fetchPapel();
                const filtered = papeis.filter(papel => 
                    (paperTypeMap[papel.type] || papel.type || '').toLowerCase().includes(query)
                );
                const tableBody = document.getElementById("papelTableBody");
                tableBody.innerHTML = "";
                filtered.forEach(papel => {
                    const displayName = paperTypeMap[papel.type] || papel.type;
                    const totalMetros = papel.qtyUnit * papel.qtyMetros;
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${displayName || '-'}</td>
                        <td>${papel.qtyUnit || 0}</td>
                        <td>${papel.qtyMetros || 0}</td>
                        <td>${totalMetros || 0}</td>
                        <td>${papel.qtyMin || 0}</td>
                        <td>
                            <button class="btn btn-primary btn-sm me-1" onclick="editProduct('papel', ${papel.id || 0})">
                                <i class="bi bi-pencil"></i> Editar
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="removeProduct('papel', ${papel.id || 0})">
                                <i class="bi bi-trash"></i> Remover
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } else if (activeTab === "tecido-tab") {
                const tecidos = await fetchTecido();
                const filtered = tecidos.filter(tecido => 
                    (tecido.type || '').toLowerCase().includes(query)
                );
                const tableBody = document.getElementById("tecidoTableBody");
                tableBody.innerHTML = "";
                filtered.forEach(tecido => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${tecido.type || '-'}</td>
                        <td>${tecido.qtyMetros || 0}</td>
                        <td>${tecido.width || 0}</td>
                        <td>${tecido.qtyMin || 0}</td>
                        <td>
                            <button class="btn btn-primary btn-sm me-1" onclick="editProduct('tecido', ${tecido.id || 0})">
                                <i class="bi bi-pencil"></i> Editar
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="removeProduct('tecido', ${tecido.id || 0})">
                                <i class="bi bi-trash"></i> Remover
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } else if (activeTab === "tecido-cortado-tab") {
                const tecidosCortados = await fetchTecidoCortado();
                const filtered = tecidosCortados.filter(tecido => 
                    (tecido.type || '').toLowerCase().includes(query)
                );
                const tableBody = document.getElementById("tecidoCortadoTableBody");
                tableBody.innerHTML = "";
                if (filtered.length === 0) {
                    const row = document.createElement("tr");
                    row.innerHTML = `<td colspan="5">Nenhum tecido cortado encontrado</td>`;
                    tableBody.appendChild(row);
                    return;
                }
                filtered.forEach(tecido => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${tecido.type || '-'}</td>
                        <td>${tecido.quantity || 0}</td>
                        <td>${tecido.measurement || '-'}</td>
                        <td>${tecido.qtyMin || 0}</td>
                        <td>
                            <button class="btn btn-primary btn-sm me-1" onclick="editProduct('tecido-cortado', ${tecido.id || 0})">
                                <i class="bi bi-pencil"></i> Editar
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="removeProduct('tecido-cortado', ${tecido.id || 0})">
                                <i class="bi bi-trash"></i> Remover
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }
        });

        // Update product selects
        async function updateProductSelects() {
            const tintas = await fetchTinta();
            const papeis = await fetchPapel();
            const tecidos = await fetchTecido();
            const tecidosCortados = await fetchTecidoCortado();
            console.log("Tecidos cortados para selects:", tecidosCortados);
            const selects = ["entryProduct", "exitProduct", "orderProduct"];
            selects.forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = "<option value='' disabled selected>Selecione um produto</option>";
                tintas.forEach(tinta => {
                    const option = document.createElement("option");
                    option.value = `tinta_${tinta.id}`;
                    option.textContent = `Tinta: ${tinta.color} (${tinta.type})`;
                    select.appendChild(option);
                });
                papeis.forEach(papel => {
                    const option = document.createElement("option");
                    option.value = `papel_${papel.id}`;
                    option.textContent = `Papel: ${paperTypeMap[papel.type] || papel.type}`;
                    select.appendChild(option);
                });
                tecidos.forEach(tecido => {
                    const option = document.createElement("option");
                    option.value = `tecido_${tecido.id}`;
                    option.textContent = `Tecido: ${tecido.type}`;
                    select.appendChild(option);
                });
                tecidosCortados.forEach(tecido => {
                    const option = document.createElement("option");
                    option.value = `tecido-cortado_${tecido.id || 0}`;
                    option.textContent = `Tecido Cortado: ${tecido.type || 'Desconhecido'} (${tecido.measurement || 'Desconhecida'})`;
                    select.appendChild(option);
                });
            });
        }

        // Supplier functions
        async function addSupplier(event) {
            event.preventDefault();
            try {
                const name = document.getElementById("supplierName").value;
                const phone = document.getElementById("supplierPhone").value;
                const email = document.getElementById("supplierEmail").value;

                if (!name || !phone || !email) throw new Error("Todos os campos são obrigatórios");

                const response = await fetch(`${API_URL}/suppliers`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ name, phone, email })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || "Failed to add supplier");
                }

                document.getElementById("addSupplierForm").reset();
                const modal = bootstrap.Modal.getInstance(document.getElementById("addSupplierModal"));
                modal.hide();
                await renderSuppliers();
                await updateSupplierSelect();
                showAlert("Fornecedor adicionado com sucesso!");
            } catch (error) {
                console.error(error);
                showAlert(`Erro ao adicionar fornecedor: ${error.message}`, 'danger');
            }
        }

        async function removeSupplier(id) {
            if (confirm("Tem certeza que deseja remover este fornecedor?")) {
                try {
                    const response = await fetch(`${API_URL}/suppliers/${id}`, { method: "DELETE" });
                    if (!response.ok) throw new Error("Failed to delete supplier");
                    await renderSuppliers();
                    await updateSupplierSelect();
                    showAlert("Fornecedor removido com sucesso!");
                } catch (error) {
                    console.error(error);
                    showAlert(`Erro ao remover fornecedor: ${error.message}`, 'danger');
                }
            }
        }

        async function updateSupplierSelect() {
            const suppliers = await fetchSuppliers();
            const selects = ["entrySupplier", "orderSupplier"];
            selects.forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = "<option value='' disabled selected>Selecione um fornecedor</option>";
                suppliers.forEach(supplier => {
                    const option = document.createElement("option");
                    option.value = supplier.id;
                    option.textContent = supplier.name;
                    select.appendChild(option);
                });
            });
        }

        // Form visibility
        category.addEventListener("change", () => {
            formTinta.classList.add("hidden-form");
            formPapel.classList.add("hidden-form");
            formTecido.classList.add("hidden-form");
            formTecidoCortado.classList.add("hidden-form");
            if (category.value === "tinta") {
                formTinta.classList.remove("hidden-form");
            } else if (category.value === "papel") {
                formPapel.classList.remove("hidden-form");
            } else if (category.value === "tecido") {
                formTecido.classList.remove("hidden-form");
            } else if (category.value === "tecido-cortado") {
                formTecidoCortado.classList.remove("hidden-form");
            }
        });

        // Tab change handling
        document.getElementById("stockTabs").addEventListener("shown.bs.tab", async function (event) {
            const target = event.target.id;
            if (target === "tinta-tab") {
                await renderTintaTable();
            } else if (target === "papel-tab") {
                await renderPapelTable();
            } else if (target === "tecido-tab") {
                await renderTecidoTable();
            } else if (target === "tecido-cortado-tab") {
                await renderTecidoCortadoTable();
            }
        });

        // UI functions
        function toggleSidebar() {
            document.getElementById("sidebar").classList.toggle("active");
        }

        function showSection(sectionId) {
            document.querySelectorAll(".section").forEach(section => section.style.display = "none");
            document.getElementById(`${sectionId}Section`).style.display = "block";
            if (sectionId === "stock") {
                renderTintaTable();
            }
            if (window.innerWidth <= 768) toggleSidebar();
        }

        // Prepare add product
        function prepareAddProduct() {
            document.getElementById("addProductForm").reset();
            document.getElementById("addProductModalLabel").textContent = "Adicionar Produto";
            document.getElementById("editProductId").value = "";
            document.getElementById("editProductCategory").value = "";
            document.getElementById("productCategory").value = "";
            formTinta.classList.add("hidden-form");
            formPapel.classList.add("hidden-form");
            formTecido.classList.add("hidden-form");
            formTecidoCortado.classList.add("hidden-form");
        }

        // Initialize
        document.addEventListener("DOMContentLoaded", async () => {
            await renderTintaTable();
            await renderSuppliers();
            await updateSupplierSelect();
            await updateProductSelects();
            showSection("stock");

            document.getElementById("addSupplierForm").addEventListener("submit", addSupplier);
            document.getElementById("entryForm").addEventListener("submit", handleStockEntry);
            document.getElementById("exitForm").addEventListener("submit", handleStockExit);
        });
    </script>
</body>
</html>
